Bootstrap: docker
From: ubuntu:20.04

%post
    # Always make APT non-interactive to avoid any prompts
    export DEBIAN_FRONTEND=noninteractive

    # Update APT and install base packages
    apt-get update
    apt-get install -y \
        wget \
        git \
        zip \
        unzip \
        sudo \
        cmake \
        tar \
        libgl1-mesa-dev \
        libgl1-mesa-glx \
        mesa-utils \
        libglew-dev \
        libosmesa6-dev \
        patchelf \
        ffmpeg \
        whiptail \
        python3 \
        python3-pip \
        build-essential \
        libboost-all-dev

    # Install Python packages
    pip3 install numpy matplotlib pandas dask distributed

    # Set timezone safely to UTC to avoid tzdata prompt
    ln -fs /usr/share/zoneinfo/Etc/UTC /etc/localtime
    echo "Etc/UTC" > /etc/timezone
    apt-get install -y tzdata
    dpkg-reconfigure -f noninteractive tzdata

%environment
    # Memory management flags (tune malloc behavior)
    export MALLOC_TRIM_THRESHOLD_=0
    export MALLOC_MMAP_THRESHOLD_=131072
    export MALLOC_MMAP_MAX_=65536

    # Make numpy use a single thread
    export OPENBLAS_NUM_THREADS=1

    # Set X11 display for GUI output (if needed)
    export DISPLAY=":1"
